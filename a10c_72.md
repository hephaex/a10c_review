# ARM10C 72주차 후기
##### 일시 : 2014.10.04 (72주차)
##### 모임명 : NAVER개발자커뮤니티지원_IAMROOT.ORG_10차ARM-C
##### 장소 : 토즈 타워점
##### 장소지원 : NAVER 개발자 커뮤니티 지원 프로그램
##### 참여인원 :  3명
============

## 스터디 진도 : 
 - tick_nohz_init()
 - context_tracking_init()
 - radix_tree_init()
 - early_irq_init();

## main.c::start_kernel()

```c
asmlinkage void __init start_kernel(void)
{

...

	boot_cpu_init();
	// 현재 cpu(core id)를 얻어서 cpu_XXX_bits[] 의 cpu를 셋한다.

...

	setup_arch(&command_line);

...

	mm_init();
	// buddy와 slab 을 활성화 하고 기존 할당 받은 bootmem 은 buddy,
	// pcpu 메모리, vmlist 는 slab으로 이관

	sched_init();
	// scheduler가 사용하는 자료 구조 초기화, idle_threads를 init_task로 세팅

	preempt_disable();
	// preempt count를 증가시켜 preemption 못하도록 막음

...

	rcu_init();
	// rcu 자료구조 bh, sched, preempt 를 각각 초기화 수행함

	tick_nohz_init(); // null function
	context_tracking_init(); // null function

	radix_tree_init();
	// radix tree로 사용하는 radix_tree_node_cachep에 kmem_cache#20을 생성 및 초기화 후 할당하고
	// height_to_maxindex을 초기화 수행

	/* init some links before init_ISA_irqs() */
	early_irq_init();
	// irq_desc 0 ~ 15 까지의 object을 할당 받고 초기화를 수행
	// allocated_irqs에 bit를 1로 세팅하고 radix tree에 각 irq_desc를 노트로 추가
```

## tick.h::tick_nohz_init()

```c
// ARM10C 20141004
static inline void tick_nohz_init(void) { }
```

## context_tracking.h::context_tracking_init()

```c
// ARM10C 20141004
static inline void context_tracking_init(void) { }
```

## radix-tree.h::radix_tree_init()

```c
// ARM10C 20141004
// #define RADIX_TREE_INIT(GFP_KERNEL):
// {
// 	.height = 0,
// 	.gfp_mask = (GFP_KERNEL),
// 	.rnode = NULL,
// }
#define RADIX_TREE_INIT(mask)	{					\
	.height = 0,							\
	.gfp_mask = (mask),						\
	.rnode = NULL,							\
}
```

## irqdesc.c::early_irq_init()

```c
// ARM10C 20141004
int __init early_irq_init(void)
{
	// first_online_node: 0
	int i, initcnt, node = first_online_node;
	// node: 0
	struct irq_desc *desc;

	init_irq_default_affinity();
	// init_irq_default_affinity에서 한일:
	// irq_default_affinity->bits[0]: 0xF

	/* Let arch update nr_irqs and return the nr of preallocated irqs */
	// arch_probe_nr_irqs(): 16
	initcnt = arch_probe_nr_irqs();
	// initcnt: 16

	// NR_IRQS: 16, nr_irqs: 16, initcnt: 16
	printk(KERN_INFO "NR_IRQS:%d nr_irqs:%d %d\n", NR_IRQS, nr_irqs, initcnt);
	// "NR_IRQS:16 nr_irqs:16 16"

	// nr_irqs: 16, IRQ_BITMAP_BITS: 8212
	if (WARN_ON(nr_irqs > IRQ_BITMAP_BITS))
		nr_irqs = IRQ_BITMAP_BITS;

	// initcnt: 16, IRQ_BITMAP_BITS: 8212
	if (WARN_ON(initcnt > IRQ_BITMAP_BITS))
		initcnt = IRQ_BITMAP_BITS;

	// initcnt: 16, nr_irqs: 16
	if (initcnt > nr_irqs)
		nr_irqs = initcnt;

	// initcnt: 16
	for (i = 0; i < initcnt; i++) {
		// i: 0, node: 0
		// alloc_desc(0, 0, NULL): kmem_cache#28-o0
		desc = alloc_desc(i, node, NULL);
		// desc: kmem_cache#28-o0

		// i: 0
		set_bit(i, allocated_irqs);
		// allocated_irqs[0]: 0x1

		// i: 0, desc: kmem_cache#28-o0
		irq_insert_desc(i, desc);
		// radix tree에 kmem_cache#28-o0를 노드로 추가

		// i: 1 ... 15 수행
	}

	// arch_early_irq_init(): 0
	return arch_early_irq_init();
	// return 0
}
```

## irq.c::init_IRQ()

```c
// ARM10C 20141004
void __init init_IRQ(void)
{
	// CONFIG_OF=y, machine_desc->init_irq: __mach_desc_EXYNOS5_DT.init_irq: 0
	if (IS_ENABLED(CONFIG_OF) && !machine_desc->init_irq)
		irqchip_init();
	else
		machine_desc->init_irq();
}
```

## Git log

```
   6cd3763..d50372f  master     -> origin/master
Updating 6cd3763..d50372f
Fast-forward
arch/arm/include/asm/bitops.h     |   2 +
arch/arm/include/asm/hw_irq.h     |   3 +
arch/arm/include/asm/irq.h        |   7 +-
arch/arm/kernel/irq.c             |   9 +-
arch/arm/kernel/vmlinux.lds.S     |   5 +-
arch/arm/lib/setbit.S             |   4 +-
drivers/irqchip/exynos-combiner.c |   5 +
drivers/irqchip/irqchip.c         |   4 +
drivers/irqchip/irqchip.h         |   1 +
drivers/of/base.c                 | 107 ++++++++++++++++++++-
drivers/of/irq.c                  |  49 +++++++++-
include/asm-generic/vmlinux.lds.h |   3 +-
include/linux/bitmap.h            |  10 ++
include/linux/bitops.h            |   5 +
include/linux/compiler.h          |   1 +
include/linux/context_tracking.h  |   3 +-
include/linux/cpu.h               |   9 ++
include/linux/cpumask.h           |  18 ++++
include/linux/gfp.h               |   4 +
include/linux/irq.h               |  32 +++++++
include/linux/irqchip.h           |   3 +-
include/linux/irqdesc.h           |  10 +-
include/linux/kernel.h            |   2 +
include/linux/list.h              |   1 +
include/linux/lockdep.h           |   2 +
include/linux/mod_devicetable.h   |   1 +
include/linux/nodemask.h          |   2 +
include/linux/of.h                |  17 +++-
include/linux/percpu.h            |   2 +
include/linux/radix-tree.h        |  25 +++++
include/linux/slab.h              |  63 ++++++++++++-
include/linux/tick.h              |   3 +-
include/linux/types.h             |   3 +
include/linux/wait.h              |   4 +
init/main.c                       |  13 ++-
kernel/cpu.c                      |   7 ++
kernel/irq/dummychip.c            |   1 +
kernel/irq/handle.c               |   1 +
kernel/irq/internals.h            |   9 +-
kernel/irq/irqdesc.c              | 193 ++++++++++++++++++++++++++++++++++++--
kernel/irq/manage.c               |   3 +-
kernel/irq/settings.h             |  13 +++
kernel/notifier.c                 |   5 +
kernel/rcu/tree.c                 |   1 +
kernel/softirq.c                  |   1 +
lib/radix-tree.c                  |  81 ++++++++++++++++
mm/percpu.c                       |   2 +
mm/slab_common.c                  |   7 ++
mm/slub.c                         |   2 +
49 files changed, 730 insertions(+), 28 deletions(-)
```
