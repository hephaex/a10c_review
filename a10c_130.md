##### KernelStudy : 130 주차 
##### 일시        : 2016.01.16 (130 주차 스터디 진행)
##### 모임명      : KernelStudy_ARM
##### 장소        : 토즈 서현점
##### 장소지원    : 공개 소프트웨어 개발자 커뮤니티 지원 프로그램
##### 참여인원    : 3명
============

## 130 주차 진도
* 129 주차 진도를 복습하였습니다.

* vfs_caches_init()
 - start_kernel        1  ~/kernel/iamroot/linux-stable/init/main.c
 - vfs_caches_init   925  ~/kernel/iamroot/linux-stable/init/main.c
 - mnt_init         3807  ~/kernel/iamroot/linux-stable/fs/dcache.c
 - kobject_create_and_add  3926  ~/kernel/iamroot/linux-stable/fs/namespace.c
 - kobject_add       828  retval = kobject_add(kobj, parent, "%s", name);
 - kobject_add_varg   457  retval = kobject_add_varg(kobj, parent, fmt, args);
 - kobject_set_name_vargs   395  retval = kobject_set_name_vargs(kobj, fmt, vargs);
 
* 129주차 함수 호출 구조
* call: start_kernel()->vfs_caches_init()
 - mnt_init()
   - kmem_cache_create()
   - alloc_large_system_hash() : mnt_cache
   - alloc_large_system_hash() : Mount-cache
   - alloc_large_system_hash() : Mountpoint-cache
   - INIT_HLIST_HEAD() : &mount_hashtable[u]
   - INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
   - sysfs_init()

* sysfs_init() 
  - kobject_create_and_add() : fs
    - kobject_create()
    - kobject_init()
  	  - kobject_init_internal() : kobj
    - kobject_add()
	  - va_start()
      - kobject_add_vargs() : kobj, fs
	    - kobject_set_name_vargs()
	      - kvasprintf()
		    - va_copy()
			- vsnprintf()
			- format_decode()
			- va_end()
			- kmalloc_track_caller()
			- kvasprintf()

## main.c::start_kernel()

* call: start_kernel()->vfs_caches_init()

```main.c
asmlinkage void __init start_kernel(void)
{
	char * command_line;
	extern const struct kernel_param __start___param[], __stop___param[];
	// ATAG,DTB 정보로 사용

...

    proc_caches_init();
	// sighand_struct, signal_struct, files_struct, fs_struct, mm_struct, vm_area_struct, nsproxy
	// 를 사용하기 위한 kmem_cache 할당자 및 percpu list 초기화 수행

	buffer_init();
	// buffer_head 를 사용하기 위한 kmem_cache 할당자 및 max_buffer_heads 값 초기화 수행

	key_init(); // null funtion
	security_init(); // null funtion
	dbg_late_init(); // null funtion

	// totalram_pages: 총 free된 page 수
	vfs_caches_init(totalram_pages);
```

## dcache.c::vfs_cache_init()

* call: start_kernel()
 - vfs_caches_init()

```dcache.c
// ARM10C 20151003
// totalram_pages: 총 free된 page 수
void __init vfs_caches_init(unsigned long mempages)
{
	unsigned long reserve;

	// mempages: 총 free된 page 수, nr_free_pages(): 현재의 free pages 수
	reserve = min((mempages - nr_free_pages()) * 3/2, mempages - 1);
	// reserve: XXX

	// mempages: 총 free된 page 수, reserve: XXX
	mempages -= reserve;
	// mempages: 총 free된 page 수 - XXX

	// PATH_MAX: 4096
	// SLAB_HWCACHE_ALIGN: 0x00002000UL, SLAB_PANIC: 0x00040000UL
	// kmem_cache_create("names_cache", 4096, 0, 0x42000, NULL): kmem_cache#6
	names_cachep = kmem_cache_create("names_cache", PATH_MAX, 0,
			SLAB_HWCACHE_ALIGN|SLAB_PANIC, NULL);
	// names_cachep: kmem_cache#6

	dcache_init();

	inode_init();

	// mempages: 총 free된 page 수 - XXX
	files_init(mempages);

	mnt_init();
```

## namespace.c::mnt_init()

* call: start_kernel()->vfs_caches_init()
  - mnt_init()

```namespace.c
// ARM10C 20151024
void __init mnt_init(void)
{
	unsigned u;
	int err;
	// sizeof(struct mount): 152 bytes, SLAB_HWCACHE_ALIGN: 0x00002000UL, SLAB_PANIC: 0x00040000UL
	// kmem_cache_create("mnt_cache", 152, 0, 0x42000, NULL): kmem_cache#2
	mnt_cache = kmem_cache_create("mnt_cache", sizeof(struct mount),
			0, SLAB_HWCACHE_ALIGN | SLAB_PANIC, NULL);
	// mnt_cache: kmem_cache#2

	// sizeof(struct hlist_head): 4 bytes, mhash_entries: 0
	// alloc_large_system_hash("Mount-cache", 4, 0, 19, 0, &m_hash_shift, &m_hash_mask, 0, 0): 16kB만큼 할당받은 메모리 주소
	mount_hashtable = alloc_large_system_hash("Mount-cache",
				sizeof(struct hlist_head),
				mhash_entries, 19,
				0,
				&m_hash_shift, &m_hash_mask, 0, 0);
	// mount_hashtable: 16kB만큼 할당받은 메모리 주소

	// sizeof(struct hlist_head): 4 bytes, mphash_entries: 0
	// alloc_large_system_hash("Mountpoint-cache", 4, 0, 19, 0, &m_hash_shift, &m_hash_mask, 0, 0): 16kB만큼 할당받은 메모리 주소
	mountpoint_hashtable = alloc_large_system_hash("Mountpoint-cache",
				sizeof(struct hlist_head),
				mphash_entries, 19,
				0,
				&mp_hash_shift, &mp_hash_mask, 0, 0);
	// mountpoint_hashtable: 16kB만큼 할당받은 메모리 주소

	// mount_hashtable: 16kB만큼 할당받은 메모리 주소, mountpoint_hashtable: 16kB만큼 할당받은 메모리 주소
	if (!mount_hashtable || !mountpoint_hashtable)
		panic("Failed to allocate mount hash table\n");

	// m_hash_mask: 0xFFF
	for (u = 0; u <= m_hash_mask; u++)
		// u: 0
		INIT_HLIST_HEAD(&mount_hashtable[u]);

		// INIT_HLIST_HEAD 에서 한일:
		// ((&mount_hashtable[0])->first = NULL)

		// u: 1...4095 까지 loop 수행

	// mp_hash_mask: 0xFFF
	for (u = 0; u <= mp_hash_mask; u++)
		// u: 0
		INIT_HLIST_HEAD(&mountpoint_hashtable[u]);

		// INIT_HLIST_HEAD 에서 한일:
		// ((&mountpoint_hashtable[0])->first = NULL)

		// u: 1...4095 까지 loop 수행

	// sysfs_init(): 0
	err = sysfs_init();
	// err: 0

	// err: 0
	if (err)
		printk(KERN_WARNING "%s: sysfs_init error: %d\n",
			__func__, err);
	fs_kobj = kobject_create_and_add("fs", NULL);
```

## kobject.c::kobject_create_and_add()

* call: start_kernel()->vfs_caches_init()->mnt_init()
    - kmem_cache_create()
	- alloc_large_system_hash() : mnt_cache
	- alloc_large_system_hash() : Mount-cache
	- alloc_large_system_hash() : Mountpoint-cache
	- INIT_HLIST_HEAD() : &mount_hashtable[u]
	- INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
	- sysfs_init()
	- kobject_create_and_add() : fs

```kobject.c
// ARM10C 20160109
// "fs", NULL
struct kobject *kobject_create_and_add(const char *name, struct kobject *parent)
{
	struct kobject *kobj;
	int retval;

	// kobject_create(): kmem_cache#30-oX (struct kobject)
	kobj = kobject_create();

	// kobj: kmem_cache#30-oX (struct kobject)
	if (!kobj)
		return NULL;

	// kobj: kmem_cache#30-oX (struct kobject), parent: NULL, name: "fs"
	retval = kobject_add(kobj, parent, "%s", name);
```

## kobject.c::kobject_add()

* call: start_kernel()->vfs_caches_init()->mnt_init()
  - kmem_cache_create()
  - alloc_large_system_hash() : mnt_cache
  - alloc_large_system_hash() : Mount-cache
  - alloc_large_system_hash() : Mountpoint-cache
  - INIT_HLIST_HEAD() : &mount_hashtable[u]
  - INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
  - sysfs_init()
  - kobject_create_and_add() : fs
    - kobject_add()
	  
```kobject.c
// ARM10C 20160109
// kobj: kmem_cache#30-oX (struct kobject), parent: NULL, "%s", name: "fs"
int kobject_add(struct kobject *kobj, struct kobject *parent,
		const char *fmt, ...)
{
	va_list args;
	int retval;

	// kobj: kmem_cache#30-oX (struct kobject)
	if (!kobj)
		return -EINVAL;

	// kobj->state_initialized: (kmem_cache#30-oX (struct kobject))->state_initialized: 1
	if (!kobj->state_initialized) {
		printk(KERN_ERR "kobject '%s' (%p): tried to add an "
		       "uninitialized object, something is seriously wrong.\n",
		       kobject_name(kobj), kobj);
		dump_stack();
		return -EINVAL;
	}

	// fmt: "%s"
	va_start(args, fmt);

	// va_start에서 한일:
	// (args): (((char *) &("%s")) + 4): "fs"

	// kobj: kmem_cache#30-oX (struct kobject), parent: NULL, fmt: "%s", args: "fs"
	retval = kobject_add_varg(kobj, parent, fmt, args);
```


## kobject.c::kobject_set_name_vargs()

* call: start_kernel()->vfs_caches_init()->mnt_init()
  - kmem_cache_create()
  - alloc_large_system_hash() : mnt_cache
  - alloc_large_system_hash() : Mount-cache
  - alloc_large_system_hash() : Mountpoint-cache
  - INIT_HLIST_HEAD() : &mount_hashtable[u]
  - INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
  - sysfs_init()
  - kobject_create_and_add() : fs
    - kobject_add()
	  - kobject_add_varg()
	  
```kobject.c
// ARM10C 20160109
// kobj: kmem_cache#30-oX (struct kobject), parent: NULL, fmt: "%s", args: "fs"
static int kobject_add_varg(struct kobject *kobj, struct kobject *parent,
			    const char *fmt, va_list vargs)
{
	int retval;

	// kobj: kmem_cache#30-oX (struct kobject), fmt: "%s", vargs: "fs"
	retval = kobject_set_name_vargs(kobj, fmt, vargs);
```

## kobject.c::kobject_set_name_vargs()

* call: start_kernel()->vfs_caches_init()->mnt_init()
  - kmem_cache_create()
  - alloc_large_system_hash() : mnt_cache
  - alloc_large_system_hash() : Mount-cache
  - alloc_large_system_hash() : Mountpoint-cache
  - INIT_HLIST_HEAD() : &mount_hashtable[u]
  - INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
  - sysfs_init()
  - kobject_create_and_add() : fs
    - kobject_add()
	  - kobject_add_varg()
	    - kobject_add_vargs()

```kobject.c
// ARM10C 20160109
// kobj: kmem_cache#30-oX (struct kobject), fmt: "%s", vargs: "fs"
int kobject_set_name_vargs(struct kobject *kobj, const char *fmt,
				  va_list vargs)
{
	// kobj->name: (kmem_cache#30-oX (struct kobject))->name: NULL
	const char *old_name = kobj->name;
	// old_name: NULL

	char *s;

	// kobj->name: (kmem_cache#30-oX (struct kobject))->name: NULL, fmt: "%s"
	if (kobj->name && !fmt)
		return 0;

	// kobj->name: (kmem_cache#30-oX (struct kobject))->name: NULL
	// GFP_KERNEL: 0xD0, fmt: "%s", vargs: "fs"
	// kvasprintf(GFP_KERNEL: 0xD0, "%s", "fs"): kmem_cache#30-oX: "fs"
	kobj->name = kvasprintf(GFP_KERNEL, fmt, vargs);
	// kobj->name: (kmem_cache#30-oX (struct kobject))->name: kmem_cache#30-oX: "fs"

	// kobj->name: (kmem_cache#30-oX (struct kobject))->name: kmem_cache#30-oX: "fs"
	if (!kobj->name)
		return -ENOMEM;

// 2016/01/09 종료

	/* ewww... some of these buggers have '/' in the name ... */
	while ((s = strchr(kobj->name, '/')))
		s[0] = '!';

	kfree(old_name);
```

## kobject.c::kobject_set_name_vargs()

* call: start_kernel()->vfs_caches_init()->mnt_init()
  - kmem_cache_create()
  - alloc_large_system_hash() : mnt_cache
  - alloc_large_system_hash() : Mount-cache
  - alloc_large_system_hash() : Mountpoint-cache
  - INIT_HLIST_HEAD() : &mount_hashtable[u]
  - INIT_HLIST_HEAD() : &mountpoint_hashtable[u]
  - sysfs_init()
  - kobject_create_and_add() : fs
    - kobject_add()
	  - kobject_add_varg()
	    - kobject_add_vargs()
		  - kfree()

```slub.c
void kfree(const void *x)
{
	struct page *page;

	// x: kmem_cache#30-o11
	void *object = (void *)x;
	// object: kmem_cache#30-o11

	// _RET_IP_: __builtin_return_address(0), object: kmem_cache#30-o11
	trace_kfree(_RET_IP_, x);

	// x: kmem_cache#30-o11, ZERO_OR_NULL_PTR(kmem_cache#30-o11): 0
	if (unlikely(ZERO_OR_NULL_PTR(x)))
		return;

	// x: kmem_cache#30-o11
	// virt_to_head_page(kmem_cache#30-o11): kmem_cache#30-o11의 page 주소
	page = virt_to_head_page(x);
	// page: kmem_cache#30-o11의 page 주소

	// page: kmem_cache#30-o11의 page 주소
	// PageSlab(kmem_cache#30-o11의 page 주소): 1
	if (unlikely(!PageSlab(page))) {
		BUG_ON(!PageCompound(page));
		kfree_hook(x);
		__free_memcg_kmem_pages(page, compound_order(page));
		return;
	}

// 2014/11/29 종료
// 2014/12/06 시작

	// page->slab_cache: (kmem_cache#30-o11의 page 주소)->slab_cache,
	// page: kmem_cache#30-o11의 page 주소, object: kmem_cache#30-o11
	slab_free(page->slab_cache, page, object, _RET_IP_);

	// slab_free에서 한일:
	// (kmem_cache#30)->cpu_slab: struct kmem_cache_cpu 자료구조를 사용하기 위해 할당받은 pcp 16 byte 메모리 공간을 구하여
	// kmem_cache#30-o11의 freepointer의 값을
	// ((kmem_cache#30)->cpu_slab + (pcpu_unit_offsets[0] + __per_cpu_start에서의pcpu_base_addr의 옵셋)->freelist 값으로 세팅
	// 값 s->cpu_slab->freelist와 c->freelist를 비교, 값 s->cpu_slab->tid와 tid을 비교 하여
	// 같을 경우에 s->cpu_slab->freelist와 s->cpu_slab->tid을 각각 object, next_tid(tid) 값으로 갱신하여
	// freelist와 tid 값을 변경함
	// kmem_cache_cpu의 freelist, tid 의 값을 변경함
}
EXPORT_SYMBOL(kfree);
```



## log

* 1st log

```
c68141d..7b4f179  master     -> origin/master
Updating c68141d..7b4f179
Fast-forward
fs/dcache.c                           | 276 ++++++++++++++++++++++-----------------------
fs/inode.c                            | 458 +++++++++++++++++++++++++++++++++++++-------------------------------------
fs/mount.h                            |  24 ++++
fs/namespace.c                        | 626 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------
fs/super.c                            | 218 ++++++++++++++++++------------------
fs/sysfs/inode.c                      | 222 ++++++++++++++++++------------------
fs/sysfs/mount.c                      | 814 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------
include/linux/err.h                   |   9 ++
include/linux/fs.h                    |   1 +
include/linux/kernel.h                |   1 +
include/linux/list.h                  |   2 +
include/linux/lockdep.h               |   2 +
include/linux/seqlock.h               | 126 +++++++++++++++++++++
include/linux/spinlock.h              |   4 +
include/linux/spinlock_types.h        |  12 ++
include/uapi/asm-generic/errno-base.h |   1 +
16 files changed, 1872 insertions(+), 924 deletions(-)
```

* 2nd log

```
7b4f179..f8705f2  master     -> origin/master
Updating 7b4f179..f8705f2
Fast-forward
README.md                         |   3 +
fs/namespace.c                    | 425 ++++++++++++++++++++++++++++++++++++++
include/acpi/actypes.h            |   5 +-
include/acpi/platform/acenv.h     |  14 ++
include/acpi/platform/aclinux.h   |   3 +
include/asm-generic/bitsperlong.h |   1 +
include/linux/ctype.h             |  13 ++
include/linux/gfp.h               |   1 +
include/linux/kobject.h           |   2 +
include/linux/kref.h              |   2 +
include/linux/list.h              |   2 +
include/linux/slab.h              |   4 +
lib/ctype.c                       |   1 +
lib/kasprintf.c                   |  25 +++
lib/kobject.c                     | 118 +++++++++++
lib/vsprintf.c                    |  91 +++++++-
mm/slub.c                         |   2 +
17 files changed, 708 insertions(+), 4 deletions(-)
```
